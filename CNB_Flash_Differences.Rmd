---
title: "CNB Flash Differences"
author: "Akira Di Sandro"
date: "11/9/2021"
output: 
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
library(ggplot2)
library(psych)
library(dplyr)
library(arules)
library(visreg)
library(lubridate)
library(mgcv)
library(tidyr)
library(reshape2)
library(irr)
library(plotly)
library(tidyverse)
library(kableExtra)
library(tibble)
```

```{r data, include=FALSE}
bigcnb <- read.csv("bigcnb_9Nov21.csv")

ADT36_A <- bigcnb[bigcnb$Version == "ADT36_A" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N" & bigcnb$code != "F" & bigcnb$code != "V3",]
AIM <- bigcnb[bigcnb$Version == "AIM" & !is.na(bigcnb$Accuracy),]
CPF_B <- bigcnb[bigcnb$Version == "CPF_B" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
ER40_D <- bigcnb[bigcnb$Version == "ER40_D" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
GNG150 <- bigcnb[bigcnb$Version == "GNG150" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
KCPW_A <- bigcnb[bigcnb$Version == "KCPW_A" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
KSPVRT_D <- bigcnb[bigcnb$Version == "KSPVRT_D" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
MEDF36_A <- bigcnb[bigcnb$Version == "MEDF36_A" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
MPRACT <- bigcnb[bigcnb$Version == "MPRACT" & !is.na(bigcnb$Speed) & bigcnb$code != "N",]
PCET_A <- bigcnb[bigcnb$Version == "PCET_A" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
PMAT24_A <- bigcnb[bigcnb$Version == "PMAT24_A" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
SCTAP <- bigcnb[bigcnb$Version == "SCTAP" & !is.na(bigcnb$Speed) & bigcnb$code != "N",]
SLNB2_90 <- bigcnb[bigcnb$Version == "SLNB2_90" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
SPCPTNL <- bigcnb[bigcnb$Version == "SPCPTNL" & bigcnb$Sub_version == "SCPT" & !is.na(bigcnb$Accuracy),]
SPCPTN90 <- bigcnb[bigcnb$Version == "SPCPTN90" & !is.na(bigcnb$Accuracy),]
SVOLT_A <- bigcnb[bigcnb$Version == "SVOLT_A" & !is.na(bigcnb$Accuracy) & bigcnb$code != "N",]
VSPLOT15 <- bigcnb[bigcnb$Version == "VSPLOT15" & !is.na(bigcnb$Accuracy),]
```


## Data

The data used for this project comes from Tableau. It is comprised of over 10,000 participants' data on 34 tasks. For the purpose of comparing Flash and non-Flash administration on these tasks, the 17 tasks listed below (which had enough participant data for Flash and non-Flash) were used.

*CNB tasks used for Flash vs non-Flash:*

* ADT36 A
* AIM
* CPF B
* ER40 D
* GNG150
* KCPW A
* KSPVRT D
* MEDF36 A
* MPRACT (Speed analysis only)
* PCET A
* PMAT24 A
* SCTAP (Speed analysis only)
* SLNB2 90
* SPCPTN90
* SPCPTNL
* SVOLT A
* VSPLOT15

## Differences in Accuracy Means

These are the results from t-tests for each task looking for differences between mean accuracy in the flash and non-flash groups. Age and sex were regressed out prior to the t-test. We started with two types of comparisons for each task: one comparison uses all available data for both Flash and non-Flash (all dates, AD), and the other compares all non-Flash data with only the last year's worth of available Flash data with all non-Flash data (last year, LY). We ultimately decided to stick with the LY analysis as the large sample size of the AD data has a strong effect on p-value. 

```{r accuracy means, include=FALSE}
texts <- c("ADT36_A","AIM","CPF_B","ER40_D","GNG150","KCPW_A","KSPVRT_D","MEDF36_A","MPRACT","PCET_A","PMAT24_A","SCTAP","SLNB2_90", "SPCPTNL","SPCPTN90","SVOLT_A","VSPLOT15")
tests <- mget(texts)

# difference in accuracy means
textsAcc <- setdiff(texts, c("MPRACT","SCTAP"))
testsAcc <- mget(textsAcc)   # 16 tests
cutoff <- as.Date("2019-12-31")
for (i in 1:length(textsAcc)) {
  test <- testsAcc[[i]]
  name <- paste0(textsAcc[i],"sumAcc")
  sumAcc <- c(textsAcc[i])
  
  # # alldates
  # fit <- gam(Accuracy ~ s(age,k=3) + gender, data = test)
  # 
  # # save summary of this model as a variable
  # fitAD <- summary(fit)
  # sumAcc <- c(sumAcc,"fitAD")
  # 
  # visreg(fit,"age", by="gender", main=paste(textsAcc[i],"AD"))
  # 
  # res <- scale(resid(fit))   # scaled residuals
  # newtest <- test[!is.na(test$Accuracy) & !is.na(test$age) & !is.na(test$gender),]
  # nflash <- newtest[newtest$flash==0,]
  # nfrownames <- row.names(nflash)
  # 
  # res <- as.data.frame(res)
  # rownames(res) <- rownames(newtest)
  # names(res) <- "residuals"
  # res$flash <- 1
  # for (j in 1:nrow(res)) {
  #   if (row.names(res[j,]) %in% nfrownames) {
  #     res[j,]$flash <- 0
  #   } else{}
  # }
  # res <- res[abs(res$residuals) <= 5,]
  # 
  # 
  # ttestAD <- t.test(res$residuals~res$flash)
  # sumAcc <- c(sumAcc,"ttestAD")
  # 
  # # effect sizes
  # AD0 <- ttestAD$estimate[[1]]
  # AD1 <- ttestAD$estimate[[2]]
  # effsizeAD <- abs(AD0-AD1)
  # sumAcc <- c(sumAcc,"effsizeAD")
  # 
  # # box plot
  # boxAD <- ggplot(res, aes(x=factor(flash),y=residuals,group=flash)) +
  #   geom_boxplot() +
  #   labs(title = paste("Accuracy Difference in",textsAcc[i],"(All dates)")) +
  #   ylab("Residuals") +
  #   scale_x_discrete("Flash",breaks=0:1,labels=c("Non-Flash", "Flash")) +
  #   ylim(-5,5)
  # sumAcc <- c(sumAcc,"boxAD")
  # nAD <- res %>%
  #   group_by(flash) %>%
  #   summarise(mean=mean(residuals),median=median(residuals),n=n())
  # sumAcc <- c(sumAcc,"nAD")
  # 
  # 
  # lastyear
  lastyear <- test[test$dotest >= cutoff,]
  lastyear <- lastyear[!is.na(lastyear$Accuracy) & !is.na(lastyear$age) & !is.na(lastyear$gender),]
  
  # use newtest to figure out proportion of participants included in both Flash and non-Flash groups
  f_sub <- unique(lastyear[lastyear$flash==1,3])               # subjects in the flash group
  both_sub <- intersect(f_sub, lastyear[lastyear$flash==0,3])  # subjects included in both groups
  sumAcc <- c(sumAcc,"both_sub")
  lastyear <- lastyear[!(lastyear$bblid%in%both_sub),]
  
  fit <- gam(Accuracy ~ s(age,k=3) + gender, data = lastyear)
  
  # save summary of this model as a variable
  fitLY <- summary(fit)
  sumAcc <- c(sumAcc,"fitLY")
  
  visreg(fit,"age", by="gender", main=paste(textsAcc[i],"LY"))
  
  res <- scale(resid(fit))   # scaled residuals
  nflash <- lastyear[lastyear$flash==0,]
  nfrownames <- row.names(nflash)
  
  res <- as.data.frame(res)
  rownames(res) <- rownames(lastyear)
  names(res) <- "residuals"
  res$flash <- 1
  for (j in 1:nrow(res)) {
    if (row.names(res[j,]) %in% nfrownames) {
      res[j,]$flash <- 0
    } else{}
  }
  res <- res[abs(res$residuals) <= 5,]
  
  ttestLY <- t.test(res$residuals~res$flash)
  sumAcc <- c(sumAcc,"ttestLY")
  
  # effect sizes
  LY0 <- ttestLY$estimate[[1]]
  LY1 <- ttestLY$estimate[[2]]
  effsizeLY <- abs(LY0-LY1)
  sumAcc <- c(sumAcc,"effsizeLY")
  
  # box plot
  boxLY <- ggplot(res, aes(x=factor(flash),y=residuals, group=flash)) +
    geom_boxplot() +
    labs(title = paste("Accuracy Difference in",textsAcc[i],"(Last year)")) +
    ylab("Residuals") +
    scale_x_discrete("Flash",breaks=0:1,labels=c("Non-Flash", "Flash")) +
    ylim(-5,5)
  sumAcc <- c(sumAcc,"boxLY")
  nLY <- res %>%
    group_by(flash) %>%
    summarise(mean=mean(residuals),median=median(residuals),n=n())
  sumAcc <- c(sumAcc,"nLY")
  
  sumAcc <- c(sumAcc[1],mget(sumAcc[-1]))
  assign(name,sumAcc)
}
```


### ADT36 A

The mean accuracy on the ADT36 A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(ADT36_AsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r ADT36 A Accuracy t-test, echo=FALSE}
ADT36_AsumAcc$ttestLY
ADT36_AsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(ADT36_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(ADT36_AsumAcc$nLY[1,4])`)



### AIM

The mean accuracy on the AIM of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(AIMsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r AIM Accuracy t-test, echo=FALSE}
AIMsumAcc$ttestLY
AIMsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(AIMsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(AIMsumAcc$nLY[1,4])`)


### CPF B

The mean accuracy on the CPF B of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(CPF_BsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r CPF B Accuracy t-test, echo=FALSE}
CPF_BsumAcc$ttestLY
CPF_BsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(ADT36_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(ADT36_AsumAcc$nLY[1,4])`)


### ER40 D

The mean accuracy on the ER40 D of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(ER40_DsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r ER40 D Accuracy t-test, echo=FALSE}
ER40_DsumAcc$ttestLY
ER40_DsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(ER40_DsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(ER40_DsumAcc$nLY[1,4])`)


### GNG150

The mean accuracy on the GNG150 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(GNG150sumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r GNG150 Accuracy t-test, echo=FALSE}
GNG150sumAcc$ttestLY
GNG150sumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(GNG150sumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(GNG150sumAcc$nLY[1,4])`)


### KCPW A

The mean accuracy on the KCPW A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(KCPW_AsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r KCPW A Accuracy t-test, echo=FALSE}
KCPW_AsumAcc$ttestLY
KCPW_AsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(KCPW_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(KCPW_AsumAcc$nLY[1,4])`)


### KSPVRT D

The mean accuracy on the KSPVRT D of the Flash group is statistically **significantly different** from the non-Flash group in the LY analysis with an effect size of `r round(KSPVRT_DsumAcc$effsizeLY,3)`. Though the difference between means is statistically significant, the box plots shows that their medians overall distribution are very similar. `r length(KSPVRT_DsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r KSPVRT D Accuracy t-test, echo=FALSE}
KSPVRT_DsumAcc$ttestLY
KSPVRT_DsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(KSPVRT_DsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(KSPVRT_DsumAcc$nLY[1,4])`)


### MEDF36 A

The mean accuracy on the KCPW A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(KCPW_AsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r MEDF36 A Accuracy t-test, echo=FALSE}
MEDF36_AsumAcc$ttestLY
MEDF36_AsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(MEDF36_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(MEDF36_AsumAcc$nLY[1,4])`)


### PCET A

The mean accuracy on the PCET A of the Flash group is statistically **significantly different** from the non-Flash group in the LY analysis with an effect size of `r PCET_AsumAcc$effsizeLY`. This may be caused by the fact that we only have `r as.numeric(PCET_AsumAcc$nLY[1,4])` participants in the non-Flash group. `r length(PCET_AsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r PCET A Accuracy t-test, echo=FALSE}
PCET_AsumAcc$ttestLY
PCET_AsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(PCET_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(PCET_AsumAcc$nLY[1,4])`)



### PMAT24 A

The mean accuracy on the PMAT24 A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(PMAT24_AsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r PMAT24 A Accuracy t-test, echo=FALSE}
PMAT24_AsumAcc$ttestLY
PMAT24_AsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(PMAT24_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(PMAT24_AsumAcc$nLY[1,4])`)


### SLNB2 90

The mean accuracy on the SLNB2 90 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SLNB2_90sumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SLNB2 90 Accuracy t-test, echo=FALSE}
SLNB2_90sumAcc$ttestLY
SLNB2_90sumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(SLNB2_90sumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(SLNB2_90sumAcc$nLY[1,4])`)


### SPCPTN90

The mean accuracy on the SPCPTN90 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SPCPTN90sumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SPCPTN90 Accuracy t-test, echo=FALSE}
SPCPTN90sumAcc$ttestLY
SPCPTN90sumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(SPCPTN90sumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(SPCPTN90sumAcc$nLY[1,4])`)


### SPCPTNL

The mean accuracy on the SPCPTNL of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SPCPTNLsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SPCPTNL Accuracy t-test, echo=FALSE}
SPCPTNLsumAcc$ttestLY
SPCPTNLsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(SPCPTNLsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(SPCPTNLsumAcc$nLY[1,4])`)


### SVOLT A

The mean accuracy on the SVOLT A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SVOLT_AsumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task. *Note: the non-Flash group sample size is on the lower side.*

```{r SVOLT A Accuracy t-test, echo=FALSE}
SVOLT_AsumAcc$ttestLY
SVOLT_AsumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(SVOLT_AsumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(SVOLT_AsumAcc$nLY[1,4])`)


### VSPLOT15

The mean accuracy on the VSPLOT15 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(VSPLOT15sumAcc$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r VSPLOT15 Accuracy t-test, echo=FALSE}
VSPLOT15sumAcc$ttestLY
VSPLOT15sumAcc$boxLY
```

Last year of Flash (n=`r as.numeric(VSPLOT15sumAcc$nLY[2,4])`), non-Flash (n=`r as.numeric(VSPLOT15sumAcc$nLY[1,4])`)









## Differences in Speed Means

These are the results from t-tests for each task looking for differences between mean speed in the flash and non-flash groups. Age and sex were regressed out prior to the t-test. We started with two types of comparisons for each task: one comparison uses all available data for both Flash and non-Flash (all dates, AD), and the other compares all non-Flash data with only the last year's worth of available Flash data with all non-Flash data (last year, LY). We ultimately decided to stick with the LY analysis as the large sample size of the AD data has a strong effect on p-value. 

```{r speed means, include=FALSE}
for (i in 1:length(texts)) {
  test <- tests[[i]]
  name <- paste0(texts[i],"sumSp")
  sumSp <- c(texts[i])
  
  # # alldates
  # fit <- gam(Speed ~ s(age,k=3) + gender, data = test)
  # 
  # fitAD <- summary(fit)
  # sumSp <- c(sumSp,"fitAD")
  # 
  # visreg(fit,"age", by="gender", main=paste(texts[i],"AD"))
  # 
  # res <- scale(resid(fit))   # scaled residuals
  # newtest <- test[!is.na(test$Speed) & !is.na(test$age) & !is.na(test$gender),]
  # nflash <- newtest[newtest$flash==0,]
  # nfrownames <- row.names(nflash)
  # 
  # res <- as.data.frame(res)
  # rownames(res) <- rownames(newtest)
  # names(res) <- "residuals"
  # res$flash <- 1
  # for (j in 1:nrow(res)) {
  #   if (row.names(res[j,]) %in% nfrownames) {
  #     res[j,]$flash <- 0
  #   } else{}
  # }
  # res <- res[abs(res$residuals) <= 5,]
  # 
  # ttestAD <- t.test(res$residuals~res$flash)
  # sumSp <- c(sumSp,"ttestAD")
  # 
  # # effect sizes
  # AD0 <- ttestAD$estimate[[1]]
  # AD1 <- ttestAD$estimate[[2]]
  # effsizeAD <- abs(AD0-AD1)
  # sumSp <- c(sumSp,"effsizeAD")
  # 
  # # box plot
  # boxAD <- ggplot(res, aes(x=factor(flash),y=residuals,group=flash)) +
  #   geom_boxplot() +
  #   labs(title = paste("Speed Differences in",texts[i],"(All dates)")) +
  #   ylab("Residuals") +
  #   scale_x_discrete("Flash",breaks=0:1,labels=c("Non-Flash", "Flash")) +
  #   ylim(-5,5)
  # sumSp <- c(sumSp,"boxAD")
  # nAD <- res %>%
  #   group_by(flash) %>%
  #   summarise(mean=mean(residuals),median=median(residuals),n=n())
  # sumSp <- c(sumSp,"nAD")
  
  if (texts[i]!="VSPLOT24") {
    lastyear <- test[test$dotest >= cutoff,]
    lastyear <- lastyear[!is.na(lastyear$Speed) & !is.na(lastyear$age) & !is.na(lastyear$gender),]
    
    # use newtest to figure out proportion of participants included in both Flash and non-Flash groups
    f_sub <- unique(lastyear[lastyear$flash==1,3])               # subjects in the flash group
    both_sub <- intersect(f_sub, lastyear[lastyear$flash==0,3])  # subjects included in both groups
    sumSp <- c(sumSp,"both_sub")
    lastyear <- lastyear[!(lastyear$bblid%in%both_sub),]
    
    fit <- gam(Speed ~ s(age,k=3) + gender, data = lastyear)
    
    fitLY <- summary(fit)
    sumSp <- c(sumSp,"fitLY")
    
    visreg(fit,"age", by="gender", main=paste(texts[i],"LY"))
    
    res <- scale(resid(fit))   # scaled residuals
    nflash <- lastyear[lastyear$flash==0,]
    nfrownames <- row.names(nflash)
    
    res <- as.data.frame(res)
    rownames(res) <- rownames(lastyear)
    names(res) <- "residuals"
    res$flash <- 1
    for (j in 1:nrow(res)) {
      if (row.names(res[j,]) %in% nfrownames) {
        res[j,]$flash <- 0
      } else{}
    }
    res <- res[abs(res$residuals) <= 5,]
    
    ttestLY <- t.test(res$residuals~res$flash)
    sumSp <- c(sumSp,"ttestLY")
    
    # effect sizes
    LY0 <- ttestLY$estimate[[1]]
    LY1 <- ttestLY$estimate[[2]]
    effsizeLY <- abs(LY0-LY1)
    sumSp <- c(sumSp,"effsizeLY")
    
    # box plot
    boxLY <- ggplot(res, aes(x=factor(flash),y=residuals, group=flash)) +
      geom_boxplot() +
      labs(title = paste("Speed Differences in",texts[i],"(Last year)")) +
      ylab("Residuals") +
      scale_x_discrete("Flash",breaks=0:1,labels=c("Non-Flash", "Flash")) +
      ylim(-5,5)
    sumSp <- c(sumSp,"boxLY")
    nLY <- res %>%
      group_by(flash) %>%
      summarise(mean=mean(residuals),median=median(residuals),n=n())
    sumSp <- c(sumSp,"nLY")
  }
  
  sumSp <- c(sumSp[1],mget(sumSp[-1]))
  assign(name,sumSp)
}
```


### ADT36 A

The mean speed on the ADT36 A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(ADT36_AsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r ADT36 A Speed t-test, echo=FALSE}
ADT36_AsumSp$ttestLY
ADT36_AsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(ADT36_AsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(ADT36_AsumSp$nLY[1,4])`)



### AIM

The mean speed on the AIM of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(AIMsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task. *Note: the Flash group sample size is on the lower side.*

```{r AIM Speed t-test, echo=FALSE}
AIMsumSp$ttestLY
AIMsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(AIMsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(AIMsumSp$nLY[1,4])`)


### CPF B

The mean speed on the CPF B of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(CPF_BsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task. 

```{r CPF B Speed t-test, echo=FALSE}
CPF_BsumSp$ttestLY
CPF_BsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(CPF_BsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(CPF_BsumSp$nLY[1,4])`)


### ER40 D

The mean speed on the ER40 D of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(ER40_DsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r ER40 D Speed t-test, echo=FALSE}
ER40_DsumSp$ttestLY
ER40_DsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(ER40_DsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(ER40_DsumSp$nLY[1,4])`)


### GNG150

The mean speed on the GNG150 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(GNG150sumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r GNG150 Speed t-test, echo=FALSE}
GNG150sumSp$ttestLY
GNG150sumSp$boxLY
```

Last year of Flash (n=`r as.numeric(GNG150sumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(GNG150sumSp$nLY[1,4])`)


### KCPW A

The mean speed on the KCPW A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(KCPW_AsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r KCPW A Speed t-test, echo=FALSE}
KCPW_AsumSp$ttestLY
KCPW_AsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(KCPW_AsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(KCPW_AsumSp$nLY[1,4])`)


### KSPVRT D

The mean speed on the KSPVRT D of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(KSPVRT_DsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r KSPVRT D Speed t-test, echo=FALSE}
KSPVRT_DsumSp$ttestLY
KSPVRT_DsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(KSPVRT_DsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(KSPVRT_DsumSp$nLY[1,4])`)


### MEDF36 A

The mean speed on the MEDF36 A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(MEDF36_AsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r MEDF36 A Speed t-test, echo=FALSE}
MEDF36_AsumSp$ttestLY
MEDF36_AsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(MEDF36_AsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(MEDF36_AsumSp$nLY[1,4])`)


### MPRACT

The mean speed on the MPRACT of the Flash group is statistically **significantly different** from the non-Flash group in the LY analysis with an effect size of `r round(MPRACTsumSp$effsizeLY,3)`. Though the difference between means is statistically significant, the box plots shows that their medians overall distribution are very similar. `r length(MPRACTsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r MPRACT Speed t-test, echo=FALSE}
MPRACTsumSp$ttestLY
MPRACTsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(MPRACTsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(MPRACTsumSp$nLY[1,4])`)


### PCET A

The mean speed on the PCET A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(PCET_AsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task. *Note: the non-Flash group sample size is on the lower side.*

```{r PCET A Speed t-test, echo=FALSE}
PCET_AsumSp$ttestLY
PCET_AsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(PCET_AsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(PCET_AsumSp$nLY[1,4])`)


### PMAT24 A

The mean speed on the PMAT24 A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(PMAT24_AsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r PMAT24 A Speed t-test, echo=FALSE}
PMAT24_AsumSp$ttestLY
PMAT24_AsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(PMAT24_AsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(PMAT24_AsumSp$nLY[1,4])`)


### SCTAP

The mean speed on the SCTAP of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SCTAPsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SCTAP Speed t-test, echo=FALSE}
SCTAPsumSp$ttestLY
SCTAPsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(SCTAPsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(SCTAPsumSp$nLY[1,4])`)


### SLNB2 90

The mean speed on the SLNB2 90 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SLNB2_90sumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SLNB2 90 Speed t-test, echo=FALSE}
SLNB2_90sumSp$ttestLY
SLNB2_90sumSp$boxLY
```

Last year of Flash (n=`r as.numeric(SLNB2_90sumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(SLNB2_90sumSp$nLY[1,4])`)


### SPCPTN90

The mean speed on the SPCPTN90 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SPCPTN90sumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SPCPTN90 Speed t-test, echo=FALSE}
SPCPTN90sumSp$ttestLY
SPCPTN90sumSp$boxLY
```

Last year of Flash (n=`r as.numeric(SPCPTN90sumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(SPCPTN90sumSp$nLY[1,4])`)


### SPCPTNL

The mean speed on the SPCPTNL of the Flash group is statistically **significantly different** from the non-Flash group in the LY analysis with an effect size of `r SPCPTNLsumSp$effsizeLY`. Though the difference between means is statistically significant, the box plots shows that their medians overall distribution are very similar. `r length(SPCPTNLsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r SPCPTNL Speed t-test, echo=FALSE}
SPCPTNLsumSp$ttestLY
SPCPTNLsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(SPCPTNLsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(SPCPTNLsumSp$nLY[1,4])`)


### SVOLT A

The mean speed on the SVOLT A of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(SVOLT_AsumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task. *Note: the non-Flash group sample size is on the lower side.*

```{r SVOLT A Speed t-test, echo=FALSE}
SVOLT_AsumSp$ttestLY
SVOLT_AsumSp$boxLY
```

Last year of Flash (n=`r as.numeric(SVOLT_AsumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(SVOLT_AsumSp$nLY[1,4])`)


### VSPLOT15

The mean speed on the VSPLOT15 of the Flash group is not significantly different from the non-Flash group in the LY analysis. `r length(VSPLOT15sumSp$both_sub)` participants were removed because they were administered both the Flash and non-Flash version of this task.

```{r VSPLOT15 Speed t-test, echo=FALSE}
VSPLOT15sumSp$ttestLY
VSPLOT15sumSp$boxLY
```

Last year of Flash (n=`r as.numeric(VSPLOT15sumSp$nLY[2,4])`), non-Flash (n=`r as.numeric(VSPLOT15sumSp$nLY[1,4])`)





## Intrasubject Comparisons

In this analysis, we look at participants who have taken tasks with both Flash and non-Flash administration. We look at the correlation coefficient between the first score they get with Flash and non-Flash administration. Then, we also look at the Intraclass correlation coefficient (ICC) of the first score they get with Flash and non-Flash administration along with up to the four most recent timepoints of Flash and non-Flash scores. Any accuracy score from a test that a participant already took previously has been corrected for practice effects in two different methods. 

Practice Effect Method 1 (PEM1) consists of taking each score past time point 1 and using the difference between that score and that of the time point immediately before it. We then use the time difference between those two time points (in days) to predict the change in score as a linear model. The newly adjusted scores are calculated by adding the residuals from that linear model to the original scores.

In Practice Effect Method 2 (PEM 2), we take the difference in means of the scores of each time point past time point 1 and the scores from the preceding time point. Then we add that difference in means to the scores of the time point past time point 1. 

The same analysis was done for Speed as well. 

### Accuracy

```{r Accuracy Intrasubject Analysis, include=FALSE}
for (j in 1:length(textsAcc)){
  test <- testsAcc[[j]]
  test <- test[!is.na(test$bblid) & !is.na(test$Accuracy),]
  
  hist <- ggplot(test,aes(x=Accuracy)) + geom_histogram()    # histogram to look at item acc frequency
  hist
  
  test <- test[!is.na(test$age),]
  if (any(j==c(2,3,11))) {     # regress age out
    fit <- gam(Accuracy ~ s(age,k=3), data = test)
  } else {
    fit <- gam(Accuracy ~ s(age), data = test)
  }
  visreg(fit,main=textsAcc[j])
  test$acc_res <- scale(resid(fit))
  test$spe_res <- 0 # spe_res doesn't matter here
  
  test <- test[abs(test$acc_res)<3,]
  
  flash <- unique(test[test$flash==1 & !is.na(test$unique_id),3])
  nflash <- unique(test[test$flash==0 & !is.na(test$unique_id),3])
  
  both <- intersect(flash, nflash)
  both <- test[test$bblid %in% both,]
  both <- both[order(both$bblid),]
  
  flash <- both[both$flash==1,]
  flash <- flash[order(flash$bblid,flash$dotest),]
  nflash <- both[both$flash==0,]
  nflash <- nflash[order(nflash$bblid,nflash$dotest),]
  
  flashcount <- flash %>%          
    group_by(bblid) %>%
    summarise(n=n())
  nflashcount <- nflash %>%
    group_by(bblid) %>%
    summarise(n=n())
  flashcount <- flashcount[order(flashcount$n, decreasing = T),]
  nflashcount <- nflashcount[order(nflashcount$n, decreasing = T),]
  
  maxflash <- na.omit(flashcount)$n[1]
  maxnflash <- na.omit(nflashcount)$n[1]
  
  tpflash <- flash[,c(1:4,8,17,19:20)]    #[t]ime [p]oint [flash]
  tpflash$timepoint <- 1
  for (i in 1:(nrow(tpflash)-1)) {
    if (tpflash$bblid[i+1] == tpflash$bblid[i]) {
      tpflash$timepoint[i+1] <- tpflash$timepoint[i] + 1
    }
  }
  tpnflash <- nflash[,c(1:4,8,17,19:20)]    #[t]ime [p]oint [n]on-[flash] used to be columns 1,4,6:7
  tpnflash$timepoint <- 1
  for (i in 1:(nrow(tpnflash)-1)) {
    if (tpnflash$bblid[i+1] == tpnflash$bblid[i]) {
      tpnflash$timepoint[i+1] <- tpnflash$timepoint[i] + 1
    }
  }
  
  fsite <- tpflash[tpflash$timepoint==1,3:4]
  nfsite <- tpnflash[tpnflash$timepoint==1,3:4]
  siteid <- merge(fsite,nfsite,by=1)
  names(siteid)[2:3] <- c("fsiteid","nfsiteid")
  
  wideflash <- reshape(tpflash[,c(3,5:9)],
                       idvar = "bblid",
                       timevar = "timepoint",
                       direction = "wide")
  widenflash <- reshape(tpnflash[,c(3,5:9)],
                        idvar = "bblid",
                        timevar = "timepoint",
                        direction = "wide")
  
  if (maxflash > 1){
    widediff <- c()
    widetime <- c()
    for (i in 2:maxflash) {
      diff <- ifelse(!is.na(wideflash[,(4*i)]),wideflash[,(4*i)] - wideflash[,(4*(i-1))],NA)
      time <- ifelse(!is.na(wideflash[,(4*i)]),difftime(wideflash[,(4*i-2)],wideflash[,(4*i-6)],units = "days"),NA)
      
      widediff <- data.frame(cbind(widediff,diff))
      widetime <- data.frame(cbind(widetime,time))
      
      names(widediff)[i-1] <- paste0("t",i,"_",i-1,"diff")
      names(widetime)[i-1] <- paste0("t",i,"_",i-1,"time")
    }
    
    wideflash <- cbind(wideflash,widediff,widetime)
    for (i in 1:(maxflash-1)) {
      wideflash <- wideflash[order(wideflash[,(1+4*maxflash + i)]),]
    }
    
    new1 <- c()
    new2 <- c()
    for (i in 2:maxflash-1) {
      diff <- lm(widediff[,i]~widetime[,i])$residuals
      newscore1 <- c(wideflash[1:length(diff),paste0("acc_res.",i+1)] + diff, rep(NA,nrow(wideflash) - length(diff)))
      meandif <- mean(wideflash[,paste0("acc_res.",i+1)],na.rm=T) - mean(wideflash[,paste0("acc_res.",i)],na.rm=T)
      newscore2 <- wideflash[,paste0("acc_res.",i+1)] + meandif
      
      new1 <- data.frame(cbind(new1,newscore1))
      new2 <- data.frame(cbind(new2,newscore2))
      
      names(new1)[i] <- paste0("t",i+1,"newscore1")
      names(new2)[i] <- paste0("t",i+1,"newscore2")
    }
    
    wideflash <- cbind(wideflash,new1,new2)
  }
  
  
  if (maxnflash > 1) {
    widendiff <- c()
    widentime <- c()
    for (i in 2:maxnflash) {
      diff <- ifelse(!is.na(widenflash[,(4*i)]),widenflash[,(4*i)] - widenflash[,(4*(i-1))],NA)
      time <- ifelse(!is.na(widenflash[,(4*i)]),difftime(widenflash[,(4*i-2)],widenflash[,(4*i-6)],units = "days"),NA)
      
      widendiff <- data.frame(cbind(widendiff,diff))
      widentime <- data.frame(cbind(widentime,time))
      
      names(widendiff)[i-1] <- paste0("t",i,"_",i-1,"diff")
      names(widentime)[i-1] <- paste0("t",i,"_",i-1,"time")
    }
    
    widenflash <- cbind(widenflash,widendiff,widentime)
    for (i in 1:(maxnflash-1)) {
      widenflash <- widenflash[order(widenflash[,(1+4*maxnflash + i)]),]
    }
    
    newn1 <- c()
    newn2 <- c()
    for (i in 2:maxnflash-1) {
      diff <- lm(widendiff[,i]~widentime[,i])$residuals
      newscore1 <- c(widenflash[1:length(diff),paste0("acc_res.",i+1)] + diff, rep(NA,nrow(widenflash) - length(diff)))
      meandif <- mean(widenflash[,paste0("acc_res.",i+1)],na.rm=T) - mean(widenflash[,paste0("acc_res.",i)],na.rm=T)
      newscore2 <- widenflash[,paste0("acc_res.",i+1)] + meandif
      
      newn1 <- data.frame(cbind(newn1,newscore1))
      newn2 <- data.frame(cbind(newn2,newscore2))
      
      names(newn1)[i] <- paste0("t",i+1,"newscore1")
      names(newn2)[i] <- paste0("t",i+1,"newscore2")
    }
    
    widenflash <- cbind(widenflash,newn1,newn2)
  }
  assign(paste0(textsAcc[j],"siteid"),siteid)
  assign(paste0(textsAcc[j],"wideflash"),wideflash)
  assign(paste0(textsAcc[j],"widenflash"),widenflash)
}
```

```{r Removing Outliers, include=FALSE}
wideflash <- ADT36_Awideflash
widenflash <- ADT36_Awidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,13)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,13)],lm=TRUE)
ADT36_A_acc <- acc  
acctxt <- c("ADT36_A_acc")

wideflash <- AIMwideflash
widenflash <- AIMwidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,11)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,11)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,11)],lm=TRUE)
AIM_acc <- acc  
acctxt <- c(acctxt,"AIM_acc")

wideflash <- CPF_Bwideflash
widenflash <- CPF_Bwidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,11)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,11)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,11)],lm=TRUE)
CPF_B_acc <- acc  
acctxt <- c(acctxt,"CPF_B_acc")

wideflash <- ER40_Dwideflash
widenflash <- ER40_Dwidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,13)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,13)],lm=TRUE)
ER40_D_acc <- acc  
acctxt <- c(acctxt,"ER40_D_acc")

wideflash <- GNG150wideflash
widenflash <- GNG150widenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,13)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,13)],lm=TRUE)
GNG150_acc <- acc  
acctxt <- c(acctxt,"GNG150_acc")

wideflash <- KCPW_Awideflash
widenflash <- KCPW_Awidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,15)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,15)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,15)],lm=TRUE)
KCPW_A_acc <- acc  
acctxt <- c(acctxt,"KCPW_A_acc")

wideflash <- KSPVRT_Dwideflash
widenflash <- KSPVRT_Dwidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,13)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,13)],lm=TRUE)
KSPVRT_D_acc <- acc  
acctxt <- c(acctxt,"KSPVRT_D_acc")

wideflash <- MEDF36_Awideflash
widenflash <- MEDF36_Awidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,13)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,13)],lm=TRUE)
MEDF36_A_acc <- acc  
acctxt <- c(acctxt,"MEDF36_A_acc")

wideflash <- PCET_Awideflash
widenflash <- PCET_Awidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,5)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,5)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,5)],lm=TRUE)
PCET_A_acc <- acc
acctxt <- c(acctxt,"PCET_A_acc")

wideflash <- PMAT24_Awideflash
widenflash <- PMAT24_Awidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,11)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,11)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,11)],lm=TRUE)
PMAT24_A_acc <- acc  
acctxt <- c(acctxt,"PMAT24_A_acc")

wideflash <- SLNB2_90wideflash
widenflash <- SLNB2_90widenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,15)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,15)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,15)],lm=TRUE)
SLNB2_90_acc <- acc  
acctxt <- c(acctxt,"SLNB2_90_acc")

wideflash <- SPCPTNLwideflash
widenflash <- SPCPTNLwidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,17)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,17)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,17)],lm=TRUE)
SPCPTNL_acc <- acc  
acctxt <- c(acctxt,"SPCPTNL_acc")

wideflash <- SVOLT_Awideflash
widenflash <- SVOLT_Awidenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,9)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,9)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,9)],lm=TRUE)
SVOLT_A_acc <- acc  
acctxt <- c(acctxt,"SVOLT_A_acc")

wideflash <- VSPLOT15wideflash
widenflash <- VSPLOT15widenflash
accflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("acc_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(accflash)[-1] <- paste0("f_",names(accflash)[-1])
accnflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("acc_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(accnflash)[-1] <- paste0("n_",names(accnflash)[-1])
acc <- data.frame(merge(accflash,accnflash, by=1))
acc_cor <- cor(acc[,-1], use="pairwise")
pairs.panels(acc[,c(2,9)],lm=TRUE)    # looking at t1 flash vs nflash
acc <- acc[abs(acc$f_acc_res.1-acc$n_acc_res.1)<2,]
pairs.panels(acc[,c(2,9)],lm=TRUE)
acc$f_acc_res.1 <- winsor(acc$f_acc_res.1,trim=0.01)
acc$n_acc_res.1 <- winsor(acc$n_acc_res.1,trim=0.01)
pairs.panels(acc[,c(2,9)],lm=TRUE)
VSPLOT15_acc <- acc  
acctxt <- c(acctxt,"VSPLOT15_acc")

accs <- mget(acctxt)
```

```{r ICC Tables, include=FALSE}
textsAcc <- setdiff(textsAcc, c("SPCPTN90"))
testsAcc <- mget(textsAcc)    # 14 tests
for (i in 1:length(acctxt)) {
  acc <- accs[[i]]
  acc_cor <- cor(acc[,-1], use="pairwise")
  
  assign(paste0(textsAcc[i],"acc_cor"),acc_cor)
  # wrap icc stuff in try()
  icc_fnf <- icc(acc[,grepl("acc_res",colnames(acc))],type="agreement",model="twoway")$value
  try(icc_f12_1 <- icc(acc[,grepl("f_acc_res",colnames(acc)) | grepl("f_t2newscore1",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_f13_1 <- icc(acc[,grepl("f_acc_res",colnames(acc)) | grepl("f_t2newscore1",colnames(acc)) | grepl("f_t3newscore1",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_f14_1 <- icc(acc[,grepl("f_acc_res",colnames(acc)) | grepl("f_t2newscore1",colnames(acc)) | grepl("f_t3newscore1",colnames(acc)) | grepl("f_t4newscore1",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_f12_2 <- icc(acc[,grepl("f_acc_res",colnames(acc)) | grepl("f_t2newscore2",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_f13_2 <- icc(acc[,grepl("f_acc_res",colnames(acc)) | grepl("f_t2newscore2",colnames(acc)) | grepl("f_t3newscore2",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_f14_2 <- icc(acc[,grepl("f_acc_res",colnames(acc)) | grepl("f_t2newscore2",colnames(acc)) | grepl("f_t3newscore2",colnames(acc)) | grepl("f_t4newscore2",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_n12_1 <- icc(acc[,grepl("n_acc_res",colnames(acc)) | grepl("n_t2newscore1",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_n13_1 <- icc(acc[,grepl("n_acc_res",colnames(acc)) | grepl("n_t2newscore1",colnames(acc)) | grepl("n_t3newscore1",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_n14_1 <- icc(acc[,grepl("n_acc_res",colnames(acc)) | grepl("n_t2newscore1",colnames(acc)) | grepl("n_t3newscore1",colnames(acc)) | grepl("n_t4newscore1",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_n12_2 <- icc(acc[,grepl("n_acc_res",colnames(acc)) | grepl("n_t2newscore2",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_n13_2 <- icc(acc[,grepl("n_acc_res",colnames(acc)) | grepl("n_t2newscore2",colnames(acc)) | grepl("n_t3newscore2",colnames(acc))],type="agreement",model="twoway")$value)
  try(icc_n14_2 <- icc(acc[,grepl("n_acc_res",colnames(acc)) | grepl("n_t2newscore2",colnames(acc)) | grepl("n_t3newscore2",colnames(acc)) | grepl("n_t4newscore2",colnames(acc))],type="agreement",model="twoway")$value)
  
  icc <- data.frame(matrix(c(icc_fnf,rep(NA,13)),nrow=2))
  rownames(icc) <- c("Flash", "Non-Flash")
  names(icc) <- c("Timepoint 1 Flash vs Non-Flash", "Timepoint 1-2 PEM1", "Timepoint 1-3 PEM1", "Timepoint 1-4 PEM1", "Timepoint 1-2 PEM2", "Timepoint 1-3 PEM2", "Timepoint 1-4 PEM2")
  try(if (icc_f12_1) {icc[1,2] <- icc_f12_1})
  try(if (icc_f13_1) {icc[1,3] <- icc_f13_1})
  try(if (icc_f14_1) {icc[1,4] <- icc_f14_1})
  try(if (icc_f12_2) {icc[1,5] <- icc_f12_2})
  try(if (icc_f13_2) {icc[1,6] <- icc_f13_2})
  try(if (icc_f14_2) {icc[1,7] <- icc_f14_2})
  try(if (icc_n12_1) {icc[2,2] <- icc_n12_1})
  try(if (icc_n13_1) {icc[2,3] <- icc_n13_1})
  try(if (icc_n14_1) {icc[2,4] <- icc_n14_1})
  try(if (icc_n12_2) {icc[2,5] <- icc_n12_2})
  try(if (icc_n13_2) {icc[2,6] <- icc_n13_2})
  try(if (icc_n14_2) {icc[2,7] <- icc_n14_2})
  
  assign(paste0(textsAcc[i],"icc"),icc)
}
```


#### ADT36 A

The participants' Flash scores correlate fairly ok with their non-Flash scores, and the correlation coefficient matches up pretty well with the ICC. (n=`r nrow(ADT36_A_acc)`)

```{r ADT36 A Accuracy intrasubject comparison, echo=FALSE}
names(ADT36_A_acc)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(ADT36_A_acc[,c(2,13)],lm=TRUE)

round(ADT36_Aicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### AIM

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up pretty well with the ICC. (n=`r nrow(AIM_acc)`)

```{r AIM Accuracy intrasubject comparison, echo=FALSE}
names(AIM_acc)[c(2,11)] <- c("Flash", "Non-Flash")
pairs.panels(AIM_acc[,c(2,11)],lm=TRUE)

round(AIMicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### CPF B

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up pretty well with the ICC. (n=`r nrow(CPF_B_acc)`)

```{r CPF B Accuracy intrasubject comparison, echo=FALSE}
names(CPF_B_acc)[c(2,11)] <- c("Flash", "Non-Flash")
pairs.panels(CPF_B_acc[,c(2,11)],lm=TRUE)

round(CPF_Bicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### ER40 D

The participants' Flash scores correlate fairly ok with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(ER40_D_acc)`)

```{r ER40 D Accuracy intrasubject comparison, echo=FALSE}
names(ER40_D_acc)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(ER40_D_acc[,c(2,13)],lm=TRUE)

round(ER40_Dicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### GNG150

The participants' Flash scores correlate **very poorly** with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(GNG150_acc)`)

```{r GNG150 Accuracy intrasubject comparison, echo=FALSE}
names(GNG150_acc)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(GNG150_acc[,c(2,13)],lm=TRUE)

round(GNG150icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### KCPW A

The participants' Flash scores correlate decently with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(KCPW_A_acc)`)

```{r KCPW A Accuracy intrasubject comparison, echo=FALSE}
names(KCPW_A_acc)[c(2,15)] <- c("Flash", "Non-Flash")
pairs.panels(KCPW_A_acc[,c(2,15)],lm=TRUE)

round(KCPW_Aicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### KSPVRT D

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(KSPVRT_D_acc)`)

```{r KSPVRT D Accuracy intrasubject comparison, echo=FALSE}
names(KSPVRT_D_acc)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(KSPVRT_D_acc[,c(2,13)],lm=TRUE)

round(KSPVRT_Dicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### MEDF36 A

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(MEDF36_A_acc)`)

```{r MEDF36 A Accuracy intrasubject comparison, echo=FALSE}
names(MEDF36_A_acc)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(MEDF36_A_acc[,c(2,13)],lm=TRUE)

round(MEDF36_Aicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### PCET A

The participants' Flash scores correlate very well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(PCET_A_acc)`)

```{r PCET A Accuracy intrasubject comparison, echo=FALSE}
names(PCET_A_acc)[c(2,5)] <- c("Flash", "Non-Flash")
pairs.panels(PCET_A_acc[,c(2,5)],lm=TRUE)

round(PCET_Aicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### PMAT24 A

The participants' Flash scores correlate very well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(PMAT24_A_acc)`)

```{r PMAT24 A Accuracy intrasubject comparison, echo=FALSE}
names(PMAT24_A_acc)[c(2,11)] <- c("Flash", "Non-Flash")
pairs.panels(PMAT24_A_acc[,c(2,11)],lm=TRUE)

round(PMAT24_Aicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SLNB2 90

The participants' Flash scores correlate fairly ok with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SLNB2_90_acc)`)

```{r SLNB2 90 Accuracy intrasubject comparison, echo=FALSE}
names(SLNB2_90_acc)[c(2,15)] <- c("Flash", "Non-Flash")
pairs.panels(SLNB2_90_acc[,c(2,15)],lm=TRUE)

round(SLNB2_90icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SPCPTN 90

Analysis omitted because there was data on only two participants who had taken this task both in Flash and non-Flash.

#### SPCPTNL

The participants' Flash scores correlate **poorly** with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SPCPTNL_acc)`)

```{r SPCPTNL Accuracy intrasubject comparison, echo=FALSE}
names(SPCPTNL_acc)[c(2,17)] <- c("Flash", "Non-Flash")
pairs.panels(SPCPTNL_acc[,c(2,17)],lm=TRUE)

round(SPCPTNLicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SVOLT A

The participants' Flash scores correlate very well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SVOLT_A_acc)`)

```{r SVOLT A Accuracy intrasubject comparison, echo=FALSE}
names(SVOLT_A_acc)[c(2,9)] <- c("Flash", "Non-Flash")
pairs.panels(SVOLT_A_acc[,c(2,9)],lm=TRUE)

round(SVOLT_Aicc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```

#### VSPLOT15

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(VSPLOT15_acc)`)

```{r VSPLOT15 Accuracy intrasubject comparison, echo=FALSE}
names(VSPLOT15_acc)[c(2,9)] <- c("Flash", "Non-Flash")
pairs.panels(VSPLOT15_acc[,c(2,9)],lm=TRUE)

round(VSPLOT15icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```



### Speed

```{r Speed intrasubject comparison, include=FALSE}
for (j in 1:length(texts)){
  test <- tests[[j]]
  test <- test[!is.na(test$bblid) & !is.na(test$Speed),]
  test$Speed <- ifelse(log(test$Speed)!= -Inf, log(test$Speed),0)
  
  hist <- ggplot(test,aes(x=Speed)) + geom_histogram()    # histogram to look at item acc frequency
  hist
  
  test <- test[!is.na(test$age),]
  if (any(j==11)) {     # regress age out
    fit <- gam(Speed ~ s(age,k=3), data = test)
  } else {
    fit <- gam(Speed ~ s(age), data = test)
  }
  visreg(fit,main=texts[j])    # regress out age first
  test$spe_res <- scale(resid(fit))
  test$acc_res <- 0 # acc_res doesn't matter
  
  test <- test[abs(test$spe_res)<3,]
  
  flash <- unique(test[test$flash==1 & !is.na(test$unique_id),3])
  nflash <- unique(test[test$flash==0 & !is.na(test$unique_id),3])
  
  both <- intersect(flash, nflash)
  both <- test[test$bblid %in% both,]
  both <- both[order(both$bblid),]
  
  flash <- both[both$flash==1,]
  flash <- flash[order(flash$bblid,flash$dotest),]
  nflash <- both[both$flash==0,]
  nflash <- nflash[order(nflash$bblid,nflash$dotest),]
  
  flashcount <- flash %>%          
    group_by(bblid) %>%
    summarise(n=n())
  nflashcount <- nflash %>%
    group_by(bblid) %>%
    summarise(n=n())
  flashcount <- flashcount[order(flashcount$n, decreasing = T),]
  nflashcount <- nflashcount[order(nflashcount$n, decreasing = T),]
  
  maxflash <- na.omit(flashcount)$n[1]
  maxnflash <- na.omit(nflashcount)$n[1]
  
  tpflash <- flash[,c(1:4,8,17,19:20)]    #[t]ime [p]oint [flash]
  tpflash$timepoint <- 1
  for (i in 1:(nrow(tpflash)-1)) {
    if (tpflash$bblid[i+1] == tpflash$bblid[i]) {
      tpflash$timepoint[i+1] <- tpflash$timepoint[i] + 1
    }
  }
  tpnflash <- nflash[,c(1:4,8,17,19:20)]    #[t]ime [p]oint [n]on-[flash] used to be columns 1,4,6:7
  tpnflash$timepoint <- 1
  for (i in 1:(nrow(tpnflash)-1)) {
    if (tpnflash$bblid[i+1] == tpnflash$bblid[i]) {
      tpnflash$timepoint[i+1] <- tpnflash$timepoint[i] + 1
    }
  }
  
  fsite <- tpflash[tpflash$timepoint==1,3:4]
  nfsite <- tpnflash[tpnflash$timepoint==1,3:4]
  siteid <- merge(fsite,nfsite,by=1)
  names(siteid)[2:3] <- c("fsiteid","nfsiteid")
  
  wideflash <- reshape(tpflash[,c(3,5:9)],
                       idvar = "bblid",
                       timevar = "timepoint",
                       direction = "wide")
  widenflash <- reshape(tpnflash[,c(3,5:9)],
                        idvar = "bblid",
                        timevar = "timepoint",
                        direction = "wide")
  
  
  if (maxflash > 1){
    widediff <- c()
    widetime <- c()
    for (i in 2:maxflash) {
      diff <- ifelse(!is.na(wideflash[,(4*i)]),wideflash[,(4*i)] - wideflash[,(4*(i-1))],NA)
      time <- ifelse(!is.na(wideflash[,(4*i)]),difftime(wideflash[,(4*i-2)],wideflash[,(4*i-6)],units = "days"),NA)
      
      widediff <- data.frame(cbind(widediff,diff))
      widetime <- data.frame(cbind(widetime,time))
      
      names(widediff)[i-1] <- paste0("t",i,"_",i-1,"diff")
      names(widetime)[i-1] <- paste0("t",i,"_",i-1,"time")
    }
    
    wideflash <- cbind(wideflash,widediff,widetime)
    for (i in 1:(maxflash-1)) {
      wideflash <- wideflash[order(wideflash[,(1+4*maxflash + i)]),]
    }
    
    new1 <- c()
    new2 <- c()
    for (i in 2:maxflash-1) {
      diff <- lm(widediff[,i]~widetime[,i])$residuals
      newscore1 <- c(wideflash[1:length(diff),paste0("spe_res.",i+1)] + diff, rep(NA,nrow(wideflash) - length(diff)))
      meandif <- mean(wideflash[,paste0("spe_res.",i+1)],na.rm=T) - mean(wideflash[,paste0("spe_res.",i)],na.rm=T)
      newscore2 <- wideflash[,paste0("spe_res.",i+1)] + meandif
      
      new1 <- data.frame(cbind(new1,newscore1))
      new2 <- data.frame(cbind(new2,newscore2))
      
      names(new1)[i] <- paste0("t",i+1,"newscore1")
      names(new2)[i] <- paste0("t",i+1,"newscore2")
    }
    
    wideflash <- cbind(wideflash,new1,new2)
  }
  
  
  if (maxnflash > 1) {
    widendiff <- c()
    widentime <- c()
    for (i in 2:maxnflash) {
      diff <- ifelse(!is.na(widenflash[,(4*i)]),widenflash[,(4*i)] - widenflash[,(4*(i-1))],NA)
      time <- ifelse(!is.na(widenflash[,(4*i)]),difftime(widenflash[,(4*i-2)],widenflash[,(4*i-6)],units = "days"),NA)
      
      widendiff <- data.frame(cbind(widendiff,diff))
      widentime <- data.frame(cbind(widentime,time))
      
      names(widendiff)[i-1] <- paste0("t",i,"_",i-1,"diff")
      names(widentime)[i-1] <- paste0("t",i,"_",i-1,"time")
    }
    
    widenflash <- cbind(widenflash,widendiff,widentime)
    for (i in 1:(maxnflash-1)) {
      widenflash <- widenflash[order(widenflash[,(1+4*maxnflash + i)]),]
    }
    
    newn1 <- c()
    newn2 <- c()
    for (i in 2:maxnflash-1) {
      diff <- lm(widendiff[,i]~widentime[,i])$residuals
      newscore1 <- c(widenflash[1:length(diff),paste0("spe_res.",i+1)] + diff, rep(NA,nrow(widenflash) - length(diff)))
      meandif <- mean(widenflash[,paste0("spe_res.",i+1)],na.rm=T) - mean(widenflash[,paste0("spe_res.",i)],na.rm=T)
      newscore2 <- widenflash[,paste0("spe_res.",i+1)] + meandif
      
      newn1 <- data.frame(cbind(newn1,newscore1))
      newn2 <- data.frame(cbind(newn2,newscore2))
      
      names(newn1)[i] <- paste0("t",i+1,"newscore1")
      names(newn2)[i] <- paste0("t",i+1,"newscore2")
    }
    
    widenflash <- cbind(widenflash,newn1,newn2)
  }
  assign(paste0(texts[j],"Spsiteid"),siteid)
  assign(paste0(texts[j],"Spwideflash"),wideflash)
  assign(paste0(texts[j],"Spwidenflash"),widenflash)
}
```

```{r Remomving outliers, include=FALSE}
wideflash <- ADT36_ASpwideflash
widenflash <- ADT36_ASpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,13)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,13)],lm=TRUE)
ADT36_A_spe <- spe  
spetxt <- c("ADT36_A_spe")

wideflash <- AIMSpwideflash
widenflash <- AIMSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,11)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,11)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,11)],lm=TRUE)
AIM_spe <- spe  
spetxt <- c(spetxt,"AIM_spe")

wideflash <- CPF_BSpwideflash
widenflash <- CPF_BSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,11)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,11)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,11)],lm=TRUE)
CPF_B_spe <- spe  
spetxt <- c(spetxt,"CPF_B_spe")

wideflash <- ER40_DSpwideflash
widenflash <- ER40_DSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,13)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,13)],lm=TRUE)
ER40_D_spe <- spe  
spetxt <- c(spetxt,"ER40_D_spe")

wideflash <-  GNG150Spwideflash
widenflash <- GNG150Spwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,13)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,13)],lm=TRUE)
GNG150_spe <- spe  
spetxt <- c(spetxt,"GNG150_spe")

wideflash <-  KCPW_ASpwideflash
widenflash <- KCPW_ASpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,15)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,15)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,15)],lm=TRUE)
KCPW_A_spe <- spe  
spetxt <- c(spetxt,"KCPW_A_spe")

wideflash <-  KSPVRT_DSpwideflash
widenflash <- KSPVRT_DSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,13)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,13)],lm=TRUE)
KSPVRT_D_spe <- spe  
spetxt <- c(spetxt,"KSPVRT_D_spe")

wideflash <-  MEDF36_ASpwideflash
widenflash <- MEDF36_ASpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,13)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,13)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,13)],lm=TRUE)
MEDF36_A_spe <- spe  
spetxt <- c(spetxt,"MEDF36_A_spe")

wideflash <-  MPRACTSpwideflash
widenflash <- MPRACTSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,15)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,15)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,15)],lm=TRUE)
MPRACT_spe <- spe  
spetxt <- c(spetxt,"MPRACT_spe")

wideflash <-  PCET_ASpwideflash
widenflash <- PCET_ASpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,5)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,5)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,5)],lm=TRUE)
PCET_A_spe <- spe
spetxt <- c(spetxt,"PCET_A_spe")

wideflash <-  PMAT24_ASpwideflash
widenflash <- PMAT24_ASpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,11)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,11)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,11)],lm=TRUE)
PMAT24_A_spe <- spe  
spetxt <- c(spetxt,"PMAT24_A_spe")

wideflash <-  SCTAPSpwideflash
widenflash <- SCTAPSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,15)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,15)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,15)],lm=TRUE)
SCTAP_spe <- spe  
spetxt <- c(spetxt,"SCTAP_spe")

wideflash <-  SLNB2_90Spwideflash
widenflash <- SLNB2_90Spwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,15)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,15)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,15)],lm=TRUE)
SLNB2_90_spe <- spe  
spetxt <- c(spetxt,"SLNB2_90_spe")

wideflash <-  SPCPTNLSpwideflash
widenflash <- SPCPTNLSpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,17)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,17)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,17)],lm=TRUE)
SPCPTNL_spe <- spe  
spetxt <- c(spetxt,"SPCPTNL_spe")

wideflash <-  SVOLT_ASpwideflash
widenflash <- SVOLT_ASpwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,9)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,9)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
# getting rid of bblid 20712 because it throws off the correlation
spe <- spe[spe$bblid != 20712,]
pairs.panels(spe[,c(2,9)],lm=TRUE)
SVOLT_A_spe <- spe  
spetxt <- c(spetxt,"SVOLT_A_spe")

wideflash <- VSPLOT15Spwideflash
widenflash <- VSPLOT15Spwidenflash
speflash <- wideflash[,grepl("bblid", colnames(wideflash)) | grepl("spe_res.1", colnames(wideflash)) | grepl("newscore", colnames(wideflash))]
names(speflash)[-1] <- paste0("f_",names(speflash)[-1])
spenflash <- widenflash[,grepl("bblid", colnames(widenflash)) | grepl("spe_res.1", colnames(widenflash)) | grepl("newscore", colnames(widenflash))]
names(spenflash)[-1] <- paste0("n_",names(spenflash)[-1])
spe <- data.frame(merge(speflash,spenflash, by=1))
spe_cor <- cor(spe[,-1], use="pairwise")
pairs.panels(spe[,c(2,9)],lm=TRUE)    # looking at t1 flash vs nflash
spe <- spe[abs(spe$f_spe_res.1-spe$n_spe_res.1)<2,]
pairs.panels(spe[,c(2,9)],lm=TRUE)
spe$f_spe_res.1 <- winsor(spe$f_spe_res.1,trim=0.01)
spe$n_spe_res.1 <- winsor(spe$n_spe_res.1,trim=0.01)
pairs.panels(spe[,c(2,9)],lm=TRUE)
VSPLOT15_spe <- spe  
spetxt <- c(spetxt,"VSPLOT15_spe")

spes <- mget(spetxt)
```


```{r ICC tables, include=FALSE}
texts <- setdiff(texts, c("SPCPTN90"))
tests <- mget(texts)   # 16 tests
for (i in 1:length(spetxt)) {
  spe <- spes[[i]]
  spe_cor <- cor(spe[,-1], use="pairwise")
  
  assign(paste0(texts[i],"spe_cor"),spe_cor)
  # wrap icc stuff in try()
  icc_fnf <- icc(spe[,grepl("spe_res",colnames(spe))],type="agreement",model="twoway")$value
  try(icc_f12_1 <- icc(spe[,grepl("f_spe_res",colnames(spe)) | grepl("f_t2newscore1",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_f13_1 <- icc(spe[,grepl("f_spe_res",colnames(spe)) | grepl("f_t2newscore1",colnames(spe)) | grepl("f_t3newscore1",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_f14_1 <- icc(spe[,grepl("f_spe_res",colnames(spe)) | grepl("f_t2newscore1",colnames(spe)) | grepl("f_t3newscore1",colnames(spe)) | grepl("f_t4newscore1",colnames(spe))], type="agreement", model="twoway")$value)
  try(icc_f12_2 <- icc(spe[,grepl("f_spe_res",colnames(spe)) | grepl("f_t2newscore2",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_f13_2 <- icc(spe[,grepl("f_spe_res",colnames(spe)) | grepl("f_t2newscore2",colnames(spe)) | grepl("f_t3newscore2",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_f14_2 <- icc(spe[,grepl("f_spe_res",colnames(spe)) | grepl("f_t2newscore2",colnames(spe)) | grepl("f_t3newscore2",colnames(spe)) | grepl("f_t4newscore2",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_n12_1 <- icc(spe[,grepl("n_spe_res",colnames(spe)) | grepl("n_t2newscore1",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_n13_1 <- icc(spe[,grepl("n_spe_res",colnames(spe)) | grepl("n_t2newscore1",colnames(spe)) | grepl("n_t3newscore1",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_n14_1 <- icc(spe[,grepl("n_spe_res",colnames(spe)) | grepl("n_t2newscore1",colnames(spe)) | grepl("n_t3newscore1",colnames(spe)) | grepl("n_t4newscore1",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_n12_2 <- icc(spe[,grepl("n_spe_res",colnames(spe)) | grepl("n_t2newscore2",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_n13_2 <- icc(spe[,grepl("n_spe_res",colnames(spe)) | grepl("n_t2newscore2",colnames(spe)) | grepl("n_t3newscore2",colnames(spe))],type="agreement",model="twoway")$value)
  try(icc_n14_2 <- icc(spe[,grepl("n_spe_res",colnames(spe)) | grepl("n_t2newscore2",colnames(spe)) | grepl("n_t3newscore2",colnames(spe)) | grepl("n_t4newscore2",colnames(spe))],type="agreement",model="twoway")$value)
  
  icc <- data.frame(matrix(c(icc_fnf,rep(NA,13)),nrow=2))
  rownames(icc) <- c("Flash", "Non-Flash")
  names(icc) <- c("Timepoint 1 Flash vs Non-Flash", "Timepoint 1-2 PEM1", "Timepoint 1-3 PEM1", "Timepoint 1-4 PEM1", "Timepoint 1-2 PEM2", "Timepoint 1-3 PEM2", "Timepoint 1-4 PEM2")
  try(if (icc_f12_1) {icc[1,2] <- icc_f12_1})
  try(if (icc_f13_1) {icc[1,3] <- icc_f13_1})
  try(if (icc_f14_1) {icc[1,4] <- icc_f14_1})
  try(if (icc_f12_2) {icc[1,5] <- icc_f12_2})
  try(if (icc_f13_2) {icc[1,6] <- icc_f13_2})
  try(if (icc_f14_2) {icc[1,7] <- icc_f14_2})
  try(if (icc_n12_1) {icc[2,2] <- icc_n12_1})
  try(if (icc_n13_1) {icc[2,3] <- icc_n13_1})
  try(if (icc_n14_1) {icc[2,4] <- icc_n14_1})
  try(if (icc_n12_2) {icc[2,5] <- icc_n12_2})
  try(if (icc_n13_2) {icc[2,6] <- icc_n13_2})
  try(if (icc_n14_2) {icc[2,7] <- icc_n14_2})
  assign(paste0(texts[i],"spe_icc"),icc)
}
```


#### ADT36 A

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up pretty well with the ICC. (n=`r nrow(ADT36_A_spe)`)

```{r ADT36 A Speed intrasubject comparison, echo=FALSE}
names(ADT36_A_spe)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(ADT36_A_spe[,c(2,13)],lm=TRUE)

round(ADT36_Aspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### AIM

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up pretty well with the ICC. (n=`r nrow(AIM_spe)`)

```{r AIM Speed intrasubject comparisonSpeed intrasubject comparison, echo=FALSE}
names(AIM_spe)[c(2,11)] <- c("Flash", "Non-Flash")
pairs.panels(AIM_spe[,c(2,11)],lm=TRUE)

round(AIMspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### CPF B

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up pretty well with the ICC. (n=`r nrow(CPF_B_spe)`)

```{r CPF B Speed intrasubject comparison, echo=FALSE}
names(CPF_B_spe)[c(2,11)] <- c("Flash", "Non-Flash")
pairs.panels(CPF_B_spe[,c(2,11)],lm=TRUE)

round(CPF_Bspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### ER40 D

The participants' Flash scores correlate fairly ok with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(ER40_D_spe)`)

```{r ER40 D Speed intrasubject comparison, echo=FALSE}
names(ER40_D_spe)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(ER40_D_spe[,c(2,13)],lm=TRUE)

round(ER40_Dspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### GNG150

The participants' Flash scores correlate very well with their non-Flash scores, and the correlation coefficient does **not** match up with the ICC as well as it has in other tasks. This is explained by the lower range of Speed residuals in the non-Flash run compared to the Flash ones. (n=`r nrow(GNG150_spe)`)

```{r GNG150 Speed intrasubject comparison, echo=FALSE}
names(GNG150_spe)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(GNG150_spe[,c(2,13)],lm=TRUE)

round(GNG150spe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### KCPW A

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(KCPW_A_spe)`)

```{r KCPW A Speed intrasubject comparison, echo=FALSE}
names(KCPW_A_spe)[c(2,15)] <- c("Flash", "Non-Flash")
pairs.panels(KCPW_A_spe[,c(2,15)],lm=TRUE)

round(KCPW_Aspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### KSPVRT D

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(KSPVRT_D_spe)`)

```{r KSPVRT D Speed intrasubject comparison, echo=FALSE}
names(KSPVRT_D_spe)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(KSPVRT_D_spe[,c(2,13)],lm=TRUE)

round(KSPVRT_Dspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### MEDF36 A

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(MEDF36_A_spe)`)

```{r MEDF36 A Speed intrasubject comparison, echo=FALSE}
names(MEDF36_A_spe)[c(2,13)] <- c("Flash", "Non-Flash")
pairs.panels(MEDF36_A_spe[,c(2,13)],lm=TRUE)

round(MEDF36_Aspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### MPRACT

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(MPRACT_spe)`)

```{r MPRACT Speed intrasubject comparison, echo=FALSE}
names(MPRACT_spe)[c(2,15)] <- c("Flash", "Non-Flash")
pairs.panels(MPRACT_spe[,c(2,15)],lm=TRUE)

round(MPRACTspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### PCET A

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(PCET_A_spe)`)

```{r PCET A Speed intrasubject comparison, echo=FALSE}
names(PCET_A_spe)[c(2,5)] <- c("Flash", "Non-Flash")
pairs.panels(PCET_A_spe[,c(2,5)],lm=TRUE)

round(PCET_Aspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### PMAT24 A

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(PMAT24_A_spe)`)

```{r PMAT24 A Speed intrasubject comparison, echo=FALSE}
names(PMAT24_A_spe)[c(2,11)] <- c("Flash", "Non-Flash")
pairs.panels(PMAT24_A_spe[,c(2,11)],lm=TRUE)

round(PMAT24_Aspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SCTAP

The participants' Flash scores correlate fairly well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SCTAP_spe)`)

```{r SCTAP Speed intrasubject comparison, echo=FALSE}
names(SCTAP_spe)[c(2,15)] <- c("Flash", "Non-Flash")
pairs.panels(SCTAP_spe[,c(2,15)],lm=TRUE)

round(SCTAPspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SLNB2 90

The participants' Flash scores correlate fairly ok with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SLNB2_90_spe)`)

```{r SLNB2 90 Speed intrasubject comparison, echo=FALSE}
names(SLNB2_90_spe)[c(2,15)] <- c("Flash", "Non-Flash")
pairs.panels(SLNB2_90_spe[,c(2,15)],lm=TRUE)

round(SLNB2_90spe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SPCPTN 90

Analysis omitted because there was data on only two participants who had taken this task both in Flash and non-Flash.

#### SPCPTNL

The participants' Flash scores correlate decently with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SPCPTNL_spe)`)

```{r SPCPTNL Speed intrasubject comparison, echo=FALSE}
names(SPCPTNL_spe)[c(2,17)] <- c("Flash", "Non-Flash")
pairs.panels(SPCPTNL_spe[,c(2,17)],lm=TRUE)

round(SPCPTNLspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```


#### SVOLT A

The participants' Flash scores correlate well with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(SVOLT_A_spe)`)

```{r SVOLT A Speed intrasubject comparison, echo=FALSE}
names(SVOLT_A_spe)[c(2,9)] <- c("Flash", "Non-Flash")
pairs.panels(SVOLT_A_spe[,c(2,9)],lm=TRUE)

round(SVOLT_Aspe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```

#### VSPLOT15

The participants' Flash scores correlate fairly ok with their non-Flash scores, and the correlation coefficient matches up well with the ICC. (n=`r nrow(VSPLOT15_spe)`)

```{r VSPLOT15 Speed intrasubject comparison, echo=FALSE}
names(VSPLOT15_spe)[c(2,9)] <- c("Flash", "Non-Flash")
pairs.panels(VSPLOT15_spe[,c(2,9)],lm=TRUE)

round(VSPLOT15spe_icc,3) %>% 
  kbl() %>% kable_classic(full_width = F, html_font = "Cambria")
```






